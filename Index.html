{"name":"Modern P2P Chess — single-file HTML (Apple-style)","type":"code/html","content":"<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1" />\n  <title>Pure Web Chess — P2P</title>\n  <style>\n    :root{\n      --bg: #0b0c0f; /* near-black /\n      --panel: rgba(255,255,255,0.08);\n      --panel-strong: rgba(255,255,255,0.12);\n      --text: #e6e8ec;\n      --muted: #a6adbb;\n      --accent: #5ac8fa; / iOS blue /\n      --accent-2: #32d74b; / iOS green /\n      --danger: #ff453a; / iOS red /\n      --shadow: 0 10px 30px rgba(0,0,0,0.5);\n      --blur: saturate(180%) blur(20px);\n      --tile-dark: #3b3f47;\n      --tile-light: #b9c0cc;\n      --tile-dark-2: #2c3036;\n      --tile-light-2: #ced5df;\n      --hl-move: rgba(90,200,250,0.25);\n      --hl-capture: rgba(255,69,58,0.3);\n      --ring: 0 0 0 2px rgba(90,200,250,0.5);\n      --radius-xl: 24px;\n      --radius-lg: 18px;\n      --radius-md: 12px;\n    }\n    {box-sizing:border-box}\n    html,body{height:100%}\n    body{\n      margin:0;\n      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";\n      color: var(--text);\n      background: radial-gradient(1200px 800px at 20% -10%, #1a1c20, transparent),\n                  radial-gradient(1000px 800px at 110% 110%, #121316, transparent),\n                  var(--bg);\n      display:grid;\n      place-items:center;\n      gap:24px;\n      padding:24px;\n    }\n    .shell{\n      width:min(1200px, 100%);\n      display:grid;\n      grid-template-columns: 1fr 360px;\n      gap:24px;\n    }\n    @media (max-width: 980px){\n      .shell{grid-template-columns:1fr}\n    }\n    .glass{\n      background: var(--panel);\n      backdrop-filter: var(--blur);\n      -webkit-backdrop-filter: var(--blur);\n      border:1px solid rgba(255,255,255,0.08);\n      border-radius: var(--radius-xl);\n      box-shadow: var(--shadow);\n    }\n    header.appbar{\n      width:min(1200px, 100%);\n      display:flex; align-items:center; justify-content:space-between;\n      padding:12px 16px;\n      gap:12px;\n    }\n    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:0.2px}\n    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}\n    .actions{display:flex;gap:8px}\n    button{appearance:none;border:0;cursor:pointer}\n    .btn{padding:10px 14px;border-radius:14px;background:var(--panel-strong);color:var(--text);font-weight:600}\n    .btn:hover{box-shadow:var(--ring)}\n    .btn.primary{background: linear-gradient(180deg, #64d2ff, #5ac8fa);} \n    .btn.success{background: linear-gradient(180deg, #45e86f, #32d74b);} \n    .btn.danger{background: linear-gradient(180deg, #ff6e64, #ff453a);} \n    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12)}\n\n    .board-wrap{\n      display:grid; grid-template-rows: auto 1fr auto; gap:14px; padding:16px;\n    }\n    .meta{display:flex;align-items:center;justify-content:space-between}\n    .tag{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.08);font-size:12px;color:var(--muted)}\n\n    .board{aspect-ratio:1; width:100%; border-radius: var(--radius-xl); overflow:hidden; position:relative; user-select:none}\n    .grid{display:grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); height:100%;}\n    .sq{display:flex; align-items:center; justify-content:center; font-size:40px; position:relative}\n    .sq.light{background: var(--tile-light)}\n    .sq.dark{background: var(--tile-dark)}\n    .sq.light.alt{background: var(--tile-light-2)}\n    .sq.dark.alt{background: var(--tile-dark-2)}\n    .sq.highlight-move::after{content:""; position:absolute; inset:0; background:var(--hl-move)}\n    .sq.highlight-capture::after{content:""; position:absolute; inset:0; background:var(--hl-capture)}\n    .sq.coord{font-size:11px;color:#0008;position:absolute;left:6px;bottom:6px}\n    .sq.dark .coord{color:#fff9}\n\n    .panel{\n      padding:16px; display:grid; gap:16px; \n    }\n    .section{background:var(--panel); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:14px;}\n    .row{display:flex; gap:10px; align-items:center}\n    .row > .grow{flex:1}\n    label{font-size:12px;color:var(--muted)}\n    input, textarea{width:100%; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); color:var(--text); padding:10px 12px; border-radius:12px; outline:none}\n    textarea{min-height:90px; resize:vertical}\n    .hint{font-size:12px; color:var(--muted)}\n    .status{font-size:14px}\n    .turn-badge{padding:6px 10px;border-radius:999px;background:rgba(50,215,75,0.15); color:#9ff7b0; font-weight:700; letter-spacing:.3px}\n    .turn-badge.them{background:rgba(90,200,250,0.15); color:#b5eaff}\n    .log{max-height:220px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; line-height:1.35}\n    .move{padding:6px 8px; border-bottom:1px solid rgba(255,255,255,0.06)}\n    .kibitz{opacity:.9}\n    .promo-modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5)}\n    .promo-card{background:var(--panel); padding:16px; border-radius:18px; width:min(360px, 90%); box-shadow:var(--shadow);}\n    .promo-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:12px}\n    .promo-piece{font-size:36px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:14px; text-align:center; cursor:pointer}\n\n    .toast{position:fixed; bottom:20px; left:50%; transform: translateX(-50%); background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); padding:10px 14px; border-radius:999px; display:none}\n\n    .foot{display:flex; justify-content:space-between; align-items:center; opacity:.85; font-size:12px}\n    .link{color:var(--accent); text-decoration:none}\n  </style>\n</head>\n<body>\n  <header class="appbar glass">\n    <div class="brand"><div class="dot"></div> Pure Web Chess</div>\n    <div class="actions">\n      <button class="btn ghost" id="flipBtn" title="Flip Board">Flip</button>\n      <button class="btn" id="newBtn" title="New Local Game">New</button>\n      <button class="btn primary" id="hostBtn" title="Host a P2P match">Create Game</button>\n      <button class="btn success" id="joinBtn" title="Join a P2P match">Join Game</button>\n    </div>\n  </header>\n\n  <div class="shell">\n    <div class="glass board-wrap">\n      <div class="meta">\n        <div class="tag" id="youTag">You: <strong>White</strong></div>\n        <div class="turn-badge" id="turnBadge">Your move</div>\n      </div>\n      <div class="board" id="board">\n        <div class="grid" id="grid"></div>\n      </div>\n      <div class="foot">\n        <div class="status" id="status">Ready.</div>\n        <div class="hint">Tip: Click a piece, then a square. Use Create/Join to play remotely (copy‑paste codes).</div>\n      </div>\n    </div>\n\n    <aside class="panel glass">\n      <div class="section">\n        <div class="row" style="justify-content:space-between">\n          <div>\n            <div style="font-weight:700">P2P Match</div>\n            <div class="hint">WebRTC data channel — no server after connect.</div>\n          </div>\n          <div class="tag" id="netState">Offline</div>\n        </div>\n        <div class="row">\n          <button class="btn primary" id="hostBtn2">Create</button>\n          <button class="btn success" id="joinBtn2">Join</button>\n          <button class="btn ghost" id="disconnectBtn">Disconnect</button>\n        </div>\n        <div class="row">\n          <div class="grow">\n            <label>Share this Offer / Paste Answer</label>\n            <textarea id="signalA" placeholder="When hosting: copy this Offer and send to your friend. When joining: paste their Answer here."></textarea>\n          </div>\n        </div>\n        <div class="row">\n          <div class="grow">\n            <label>Paste Offer / Share this Answer</label>\n            <textarea id="signalB" placeholder="When joining: paste their Offer here and press 'Accept'. When hosting: copy this Answer and send back."></textarea>\n          </div>\n        </div>\n        <div class="row">\n          <button class="btn" id="acceptOfferBtn">Accept</button>\n          <button class="btn" id="setAnswerBtn">Set Answer</button>\n        </div>\n      </div>\n\n      <div class="section">\n        <div style="font-weight:700">Moves</div>\n        <div id="moveLog" class="log"></div>\n      </div>\n\n      <div class="section">\n        <div style="font-weight:700">Options</div>\n        <div class="row">\n          <button class="btn" id="undoBtn">Undo (local)</button>\n          <button class="btn danger" id="resetBtn">Reset</button>\n        </div>\n      </div>\n\n      <div class="section kibitz">\n        <div style="font-weight:700">About</div>\n        <div class="hint">All in one file. Real chess rules incl. castling, en passant, and promotion. P2P uses WebRTC (copy‑paste signaling). No servers needed after connect.</div>\n      </div>\n    </aside>\n  </div>\n\n  <div class="promo-modal" id="promoModal">\n    <div class="promo-card">\n      <div style="font-weight:700">Promotion — choose a piece</div>\n      <div class="promo-grid">\n        <div class="promo-piece" data-piece="q">♛</div>\n        <div class="promo-piece" data-piece="r">♜</div>\n        <div class="promo-piece" data-piece="b">♝</div>\n        <div class="promo-piece" data-piece="n">♞</div>\n      </div>\n    </div>\n  </div>\n\n  <div class="toast" id="toast"></div>\n\n  <script>\n    // ============================\n    // Utilities & Unicode Pieces\n    // ============================\n    const PIECE_UNI = {\n      'wP':'♙','wR':'♖','wN':'♘','wB':'♗','wQ':'♕','wK':'♔',\n      'bP':'♟','bR':'♜','bN':'♞','bB':'♝','bQ':'♛','bK':'♚'\n    };\n    const FILES = ['a','b','c','d','e','f','g','h'];\n    const within = (x,a,b)=> x>=a && x<=b;\n    const idx = (r,c)=> r8+c; // 0..63\n    const rcOf = i => [Math.floor(i/8), i%8];\n    const clone = o => JSON.parse(JSON.stringify(o));\n\n    // ============================\n    // Chess State\n    // ============================\n    let initial = {\n      board: [\n        'bR','bN','bB','bQ','bK','bB','bN','bR',\n        'bP','bP','bP','bP','bP','bP','bP','bP',\n        null,null,null,null,null,null,null,null,\n        null,null,null,null,null,null,null,null,\n        null,null,null,null,null,null,null,null,\n        null,null,null,null,null,null,null,null,\n        'wP','wP','wP','wP','wP','wP','wP','wP',\n        'wR','wN','wB','wQ','wK','wB','wN','wR'\n      ],\n      turn: 'w',\n      castling: {w:{K:true,Q:true}, b:{K:true,Q:true}},\n      ep: -1, // en passant index\n      halfmove: 0,\n      fullmove: 1\n    };\n\n    let history = [];\n    let S = clone(initial);\n\n    // ============================\n    // Rendering\n    // ============================\n    const grid = document.getElementById('grid');\n    const statusEl = document.getElementById('status');\n    const logEl = document.getElementById('moveLog');\n    const turnBadge = document.getElementById('turnBadge');\n    const youTag = document.getElementById('youTag');\n    const toastEl = document.getElementById('toast');\n\n    let flipped = false;\n    let selected = -1;\n    let legalTargets = new Set();\n\n    function algebra(i){ const [r,c]=rcOf(i); return FILES[c] + (8-r); }\n\n    function draw(){\n      grid.innerHTML = '';\n      for(let r=0;r<8;r++){\n        for(let c=0;c<8;c++){\n          const i = idx(r,c);\n          const s = document.createElement('div');\n          s.className = 'sq ' + (((r+c)%2===0)?'light':'dark') + ( ((Math.floor(r/2)+Math.floor(c/2))%2===0)?'':' alt');\n          s.dataset.i = i;\n          const p = S.board[i];\n          if(p){ s.textContent = PIECE_UNI[p]; }\n          // coords\n          if(r===7||c===0){\n            const coord = document.createElement('div');\n            coord.className = 'coord';\n            coord.textContent = (r===7?FILES[c]:'') + (c===0?(8-r):'');\n            s.appendChild(coord);\n          }\n          s.addEventListener('click', onSquareClick);\n          grid.appendChild(s);\n        }\n      }\n      applyHighlights();\n      updateMeta();\n    }\n\n    function applyHighlights(){\n      document.querySelectorAll('.sq').forEach(el=>{\n        el.classList.remove('highlight-move','highlight-capture');\n      });\n      legalTargets.forEach(i=>{\n        const el = grid.children[i];\n        if(!el) return;\n        if(S.board[i]) el.classList.add('highlight-capture');\n        else el.classList.add('highlight-move');\n      });\n    }\n\n    function updateMeta(){\n      const meIsWhite = myColor()==='w';\n      youTag.innerHTML = You: <strong>${meIsWhite?'White':'Black'}</strong>;\n      const inCheck = isKingAttacked(S, S.turn);\n      let txt = (S.turn==='w'?'White':'Black')+" to move.";\n      if(inCheck) txt += " Check!";\n      if(gameOver(S)){\n        const res = result(S);\n        txt = res.text;\n      }\n      statusEl.textContent = txt;\n      turnBadge.className = 'turn-badge ' + (S.turn===myColor()? '' : 'them');\n      turnBadge.textContent = S.turn===myColor()? 'Your move' : "Opponent's move";\n    }\n\n    // ============================\n    // Move Generation & Rules\n    // ============================\n    function colorOf(p){ return p? p[0] : null; }\n    function typeOf(p){ return p? p[1] : null; }\n\n    function attacksFrom(state, i){\n      const p = state.board[i]; if(!p) return [];\n      const col = colorOf(p), t = typeOf(p);\n      const [r,c] = rcOf(i);\n      const moves = [];\n      const push=(rr,cc)=>{ const j=idx(rr,cc); if(j>=0) moves.push(j); };\n      // Directions helpers\n      const ray=(dr,dc)=>{\n        let rr=r+dr, cc=c+dc;\n        while(within(rr,0,7)&&within(cc,0,7)){\n          const j=idx(rr,cc); const q=state.board[j];\n          moves.push(j);\n          if(q) break; rr+=dr; cc+=dc;\n        }\n      };\n      if(t==='P'){\n        const dir = col==='w'?-1:1; // white up (to r-1)\n        // captures\n        for(const dc of [-1,1]){\n          const rr=r+dir, cc=c+dc;\n          if(within(rr,0,7)&&within(cc,0,7)) push(rr,cc);\n        }\n        // NOTE: pawn forward moves are not attacks; handled in legal moves\n      } else if(t==='N'){\n        [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>{\n          const rr=r+dr, cc=c+dc; if(within(rr,0,7)&&within(cc,0,7)) push(rr,cc);\n        });\n      } else if(t==='B'||t==='Q'){\n        ray(-1,-1); ray(-1,1); ray(1,-1); ray(1,1);\n        if(t==='Q'){ ray(-1,0); ray(1,0); ray(0,-1); ray(0,1);} \n      } else if(t==='R'){\n        ray(-1,0); ray(1,0); ray(0,-1); ray(0,1);\n      } else if(t==='K'){\n        for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++) if(dr||dc){\n          const rr=r+dr, cc=c+dc; if(within(rr,0,7)&&within(cc,0,7)) push(rr,cc);\n        }\n      }\n      return moves;\n    }\n\n    function isSquareAttacked(state, sq, byColor){\n      // check if any piece of byColor attacks sq\n      for(let i=0;i<64;i++){\n        const p = state.board[i];\n        if(!p || colorOf(p)!==byColor) continue;\n        const t = typeOf(p);\n        const [r,c] = rcOf(i);\n        const targets = attacksFrom(state, i);\n        for(const j of targets){\n          if(typeOf(p)==='P'){\n            const dir = byColor==='w'?-1:1;\n            const [rr,cc]=rcOf(i);\n            const [tr,tc]=rcOf(j);\n            if(tr===rr+dir && Math.abs(tc-cc)===1 && j===sq){return true;}\n          } else {\n            if(j===sq){\n              // Need to ensure sliding pieces don't leap over: handled in attacksFrom\n              // But for pawns, we already handled special.\n              return true;\n            }\n          }\n        }\n      }\n      return false;\n    }\n\n    function kingSquare(state, color){\n      for(let i=0;i<64;i++){ if(state.board[i]===(color+'K')) return i; }\n      return -1;\n    }\n\n    function isKingAttacked(state, color){\n      const k = kingSquare(state, color); if(k<0) return false;\n      return isSquareAttacked(state, k, color==='w'?'b':'w');\n    }\n\n    function genLegalMoves(state, from){\n      const piece = state.board[from];\n      if(!piece) return [];\n      const col = colorOf(piece), t=typeOf(piece);\n      if(col!==state.turn) return [];\n      const [r,c] = rcOf(from);\n      const moves=[];\n      const addIfLegal=(to, extra={})=>{\n        // simulate move\n        const s = clone(state);\n        makeMoveNoCheck(s, from, to, extra);\n        if(!isKingAttacked(s, col)) moves.push({from,to, ...extra});\n      };\n\n      const empty = i=> !state.board[i];\n      const enemy = i=> state.board[i] && colorOf(state.board[i])!==col;\n\n      if(t==='P'){\n        const dir = col==='w'?-1:1;\n        const oneR = r+dir; if(within(oneR,0,7)){\n          const one = idx(oneR,c);\n          if(empty(one)){\n            // promotion check\n            if(oneR=== (col==='w'?0:7)) addIfLegal(one, {promo:'q'});\n            else addIfLegal(one);\n            // double\n            const startR = (col==='w'?6:1);\n            if(r===startR){\n              const two = idx(r+2dir, c);\n              if(empty(two)) addIfLegal(two, {epTarget: idx(r+dir,c)});\n            }\n          }\n        }\n        // captures\n        for(const dc of [-1,1]){\n          const rr=r+dir, cc=c+dc; if(!within(rr,0,7)||!within(cc,0,7)) continue;\n          const j = idx(rr,cc);\n          if(enemy(j)){\n            if(rr=== (col==='w'?0:7)) addIfLegal(j, {promo:'q'}); else addIfLegal(j);\n          }\n        }\n        // en passant\n        if(state.ep>=0){\n          const [er,ec]=rcOf(state.ep);\n          if(er===r+dir && Math.abs(ec-c)===1){\n            const j = idx(er,ec);\n            addIfLegal(j, {enpassant:true});\n          }\n        }\n      } else if(t==='N'){\n        [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>{\n          const rr=r+dr, cc=c+dc; if(!within(rr,0,7)||!within(cc,0,7)) return;\n          const j = idx(rr,cc); if(!state.board[j]||enemy(j)) addIfLegal(j);\n        });\n      } else if(t==='B' || t==='R' || t==='Q'){\n        const dirs=[];\n        if(t==='B' || t==='Q') dirs.push([-1,-1],[-1,1],[1,-1],[1,1]);\n        if(t==='R' || t==='Q') dirs.push([-1,0],[1,0],[0,-1],[0,1]);\n        for(const [dr,dc] of dirs){\n          let rr=r+dr, cc=c+dc;\n          while(within(rr,0,7)&&within(cc,0,7)){\n            const j = idx(rr,cc);\n            if(!state.board[j]){ addIfLegal(j); }\n            else { if(enemy(j)) addIfLegal(j); break; }\n            rr+=dr; cc+=dc;\n          }\n        }\n      } else if(t==='K'){\n        for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++) if(dr||dc){\n          const rr=r+dr, cc=c+dc; if(!within(rr,0,7)||!within(cc,0,7)) continue;\n          const j = idx(rr,cc); if(!state.board[j]||enemy(j)) addIfLegal(j);\n        }\n        // castling\n        const rights = state.castling[col];\n        const enemyCol = col==='w'?'b':'w';\n        if(!isKingAttacked(state,col)){\n          // king side\n          if(rights.K){\n            const f = idx(r,5), g = idx(r,6);\n            if(!state.board[f] && !state.board[g] && !isSquareAttacked(state,f,enemyCol) && !isSquareAttacked(state,g,enemyCol)){\n              const rookSq = idx(r,7);\n              if(state.board[rookSq]===col+'R') addIfLegal(g, {castle:'K'});\n            }\n          }\n          // queen side\n          if(rights.Q){\n            const d = idx(r,3), c2 = idx(r,2), b2 = idx(r,1);\n            if(!state.board[d] && !state.board[c2] && !state.board[b2] && !isSquareAttacked(state,d,enemyCol) && !isSquareAttacked(state,c2,enemyCol)){\n              const rookSq = idx(r,0);\n              if(state.board[rookSq]===col+'R') addIfLegal(c2, {castle:'Q'});\n            }\n          }\n        }\n      }\n      return moves;\n    }\n\n    function makeMoveNoCheck(state, from, to, extra){\n      const p = state.board[from];\n      const col = colorOf(p), t=typeOf(p);\n      state.ep = -1;\n      // Handle en passant\n      if(extra.enpassant){\n        const dir = col==='w'?-1:1;\n        const [tr,tc]=rcOf(to);\n        const captured = idx(tr - dir, tc);\n        state.board[captured] = null;\n      }\n      // Move piece\n      state.board[to] = p;\n      state.board[from] = null;\n\n      // Promotion\n      if(extra.promo){\n        state.board[to] = col + extra.promo.toUpperCase();\n      }\n\n      // Castling rights and rook move\n      if(t==='K'){\n        state.castling[col].K=false; state.castling[col].Q=false;\n        if(extra.castle==='K'){\n          // move rook h->f\n          const r = (col==='w'?7:0);\n          state.board[idx(r,5)] = col+'R';\n          state.board[idx(r,7)] = null;\n        } else if(extra.castle==='Q'){\n          const r = (col==='w'?7:0);\n          state.board[idx(r,3)] = col+'R';\n          state.board[idx(r,0)] = null;\n        }\n      }\n      if(t==='R'){\n        // if rook moves, update rights\n        if(from===idx(7,0)) state.castling.w.Q=false;\n        if(from===idx(7,7)) state.castling.w.K=false;\n        if(from===idx(0,0)) state.castling.b.Q=false;\n        if(from===idx(0,7)) state.castling.b.K=false;\n      }\n      // if rook captured, update opponent rights\n      if(to===idx(7,0)) state.castling.w.Q=false;\n      if(to===idx(7,7)) state.castling.w.K=false;\n      if(to===idx(0,0)) state.castling.b.Q=false;\n      if(to===idx(0,7)) state.castling.b.K=false;\n\n      // Double pawn push sets ep target\n      if(extra.epTarget!==undefined) state.ep = extra.epTarget;\n\n      // Turn / move counters (simple)\n      state.turn = (state.turn==='w'?'b':'w');\n      state.halfmove = (t==='P' || extra.enpassant || extra.capture)?0: (state.halfmove+1);\n      if(state.turn==='w') state.fullmove++;\n    }\n\n    function move(state, from, to, extra){\n      const before = clone(state);\n      makeMoveNoCheck(state, from, to, extra);\n      history.push(before);\n    }\n\n    function undo(){ if(history.length){ S = history.pop(); syncLocal(); draw(); }}\n\n    function hasAnyLegalMove(state){\n      for(let i=0;i<64;i++){\n        const p = state.board[i]; if(!p || colorOf(p)!==state.turn) continue;\n        if(genLegalMoves(state,i).length) return true;\n      }\n      return false;\n    }\n\n    function gameOver(state){\n      if(hasAnyLegalMove(state)) return false;\n      const inCheck = isKingAttacked(state, state.turn);\n      return true; // checkmate or stalemate\n    }\n    function result(state){\n      const inCheck = isKingAttacked(state, state.turn);\n      if(inCheck){\n        const winner = state.turn==='w'?'Black':'White';\n        return {text: Checkmate — ${winner} wins.};\n      } else {\n        return {text: 'Stalemate — draw.'};\n      }\n    }\n\n    // ============================\n    // Interaction\n    // ============================\n    function onSquareClick(e){\n      const i = parseInt(e.currentTarget.dataset.i);\n      const me = myColor();\n      if(connected && S.turn!==me) return; // not your move\n      const p = S.board[i];\n      if(selected<0){\n        if(!p || colorOf(p)!==S.turn || colorOf(p)!==me) return;\n        selected = i;\n        const moves = genLegalMoves(S, i);\n        legalTargets = new Set(moves.map(m=>m.to));\n        applyHighlights();\n      } else {\n        if(i===selected){ selected=-1; legalTargets.clear(); applyHighlights(); return; }\n        const moves = genLegalMoves(S, selected);\n        const found = moves.find(m=>m.to===i);\n        if(!found){\n          // If clicked your own piece, reselect\n          if(p && colorOf(p)===S.turn && colorOf(p)===me){\n            selected = i; legalTargets = new Set(genLegalMoves(S,i).map(m=>m.to)); applyHighlights();\n          }\n          return;\n        }\n        // Handle promotion UI\n        const [tr] = rcOf(i);\n        const moving = S.board[selected];\n        if(typeOf(moving)==='P' && (tr===0||tr===7) && !found.promo){\n          openPromotion(choice=>{\n            found.promo = choice;\n            commitMove(found);\n          }, colorOf(moving));\n          return;\n        }\n        commitMove(found);\n      }\n    }\n\n    function commitMove(found){\n      const algebraMove = ${algebra(found.from)}-${algebra(found.to)} + (found.promo?=${found.promo.toUpperCase()}:'');\n      move(S, found.from, found.to, found);\n      log(algebraMove);\n      selected=-1; legalTargets.clear(); draw();\n      if(connected){ send({type:'move', move:found}); }\n    }\n\n    function log(t){\n      const el = document.createElement('div');\n      el.className='move';\n      el.textContent = ${S.turn==='w'?S.fullmove-1:S.fullmove}. ${t};\n      logEl.appendChild(el); logEl.scrollTop = logEl.scrollHeight;\n    }\n\n    function openPromotion(cb, color){\n      const modal = document.getElementById('promoModal');\n      modal.style.display='flex';\n      const handler = (e)=>{\n        if(e.target.classList.contains('promo-piece')){\n          const pc = e.target.getAttribute('data-piece');\n          modal.style.display='none';\n          document.removeEventListener('click', handler, true);\n          cb(pc);\n        }\n      };\n      document.addEventListener('click', handler, true);\n    }\n\n    // ============================\n    // Board orientation & setup\n    // ============================\n    function myColor(){ return flipped? 'b':'w'; }\n    function flip(){ flipped=!flipped; grid.style.transform = flipped? 'rotate(180deg)':'none';\n      // rotate piece glyphs back upright\n      document.querySelectorAll('.sq').forEach(el=>{ el.style.transform = flipped? 'rotate(180deg)':'none'; });\n      draw();\n    }\n\n    function reset(){ history=[]; S=clone(initial); legalTargets.clear(); selected=-1; draw(); broadcastSync(); }\n    function newLocal(){ reset(); toast('New game. You are White.'); if(flipped) flip(); }\n\n    function syncLocal(){ // show last two ranks numbers correct after flip\n      grid.style.transform = flipped? 'rotate(180deg)':'none';\n      document.querySelectorAll('.sq').forEach(el=>{ el.style.transform = flipped? 'rotate(180deg)':'none'; });\n    }\n\n    // ============================\n    // Simple P2P via WebRTC (copy‑paste SDP)\n    // ============================\n    const netState = document.getElementById('netState');\n    const hostBtn = document.getElementById('hostBtn');\n    const joinBtn = document.getElementById('joinBtn');\n    const hostBtn2 = document.getElementById('hostBtn2');\n    const joinBtn2 = document.getElementById('joinBtn2');\n    const disconnectBtn = document.getElementById('disconnectBtn');\n    const signalA = document.getElementById('signalA');\n    const signalB = document.getElementById('signalB');\n    const acceptOfferBtn = document.getElementById('acceptOfferBtn');\n    const setAnswerBtn = document.getElementById('setAnswerBtn');\n\n    let pc=null, dc=null, connected=false, isHost=false;\n\n    function setupPC(){\n      pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});\n      pc.onicecandidate = ()=>{ updateSignals(); };\n      pc.onconnectionstatechange = ()=>{\n        const st = pc.connectionState;\n        netState.textContent = st;\n        if(st==='connected'){ connected=true; toast('Connected'); if(isHost){ if(!flipped) flip(); /* host is Black */ }\n        }\n        if(st==='disconnected'||st==='closed'||st==='failed'){ connected=false; toast('Disconnected'); }\n      };\n      pc.ondatachannel = (e)=>{ dc = e.channel; bindDC(); };\n    }\n    function bindDC(){\n      dc.onmessage = (e)=>{\n        const msg = JSON.parse(e.data);\n        if(msg.type==='move'){\n          // apply opponent move\n          history.push(clone(S));\n          makeMoveNoCheck(S, msg.move.from, msg.move.to, msg.move);\n          log("... " + algebra(msg.move.from)+"-"+algebra(msg.move.to)+(msg.move.promo?"="+msg.move.promo.toUpperCase():""));\n          selected=-1; legalTargets.clear(); draw();\n        } else if(msg.type==='sync'){\n          S = msg.state; history=[]; draw();\n        }\n      };\n      dc.onopen = ()=>{ netState.textContent = 'connected'; connected=true; toast('Channel open'); broadcastSync(); };\n      dc.onclose = ()=>{ netState.textContent = 'closed'; connected=false; };\n    }\n\n    function updateSignals(){\n      if(isHost){\n        pc.createOffer().then(offer=>pc.setLocalDescription(offer)).then(()=>{\n          signalA.value = btoa(JSON.stringify(pc.localDescription));\n        });\n      } else {\n        // as joiner, set answer value after localDescription exists\n        if(pc.localDescription){ signalB.value = btoa(JSON.stringify(pc.localDescription)); }\n      }\n    }\n\n    function broadcastSync(){ if(connected && dc?.readyState==='open'){ dc.send(JSON.stringify({type:'sync', state:S})); } }\n\n    function createGame(){\n      isHost=true; setupPC();\n      dc = pc.createDataChannel('chess'); bindDC();\n      pc.createOffer().then(offer=>pc.setLocalDescription(offer)).then(()=>{\n        signalA.value = btoa(JSON.stringify(pc.localDescription));\n        netState.textContent='waiting';\n        toast('Copy Offer and send to friend');\n      });\n    }\n\n    function joinGame(){\n      isHost=false; setupPC();\n      toast('Paste Offer and press Accept');\n    }\n\n    acceptOfferBtn.onclick = async ()=>{\n      try{\n        const offer = JSON.parse(atob(signalB.value.trim()));\n        await pc.setRemoteDescription(offer);\n        const ans = await pc.createAnswer();\n        await pc.setLocalDescription(ans);\n        signalA.value = btoa(JSON.stringify(pc.localDescription));\n        toast('Copy Answer back to host');\n      }catch(e){ toast('Invalid Offer'); }\n    };\n\n    setAnswerBtn.onclick = async ()=>{\n      try{\n        const answer = JSON.parse(atob(signalB.value.trim()));\n        await pc.setRemoteDescription(answer);\n        toast('Answer set. Connecting…');\n      }catch(e){ toast('Invalid Answer'); }\n    };\n\n    hostBtn.onclick = hostBtn2.onclick = ()=>{ createGame(); };\n    joinBtn.onclick = joinBtn2.onclick = ()=>{ joinGame(); };\n    disconnectBtn.onclick = ()=>{ try{ pc.close(); }catch{} connected=false; netState.textContent='offline'; };\n\n    // ============================\n    // Controls\n    // ============================\n    document.getElementById('flipBtn').onclick = flip;\n    document.getElementById('newBtn').onclick = newLocal;\n    document.getElementById('resetBtn').onclick = reset;\n    document.getElementById('undoBtn').onclick = undo;\n\n    function toast(t){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',2000); }\n\n    // ============================\n    // Init\n    // ============================\n    draw();\n  </script>\n</body>\n</html>"}

